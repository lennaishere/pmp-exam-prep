<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMP One-Take Pass: Final Blitz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATA: High-Yield PMP Specialized Questions ---
        const QUESTION_BANK = [
            { id: 1, category: "Process", difficulty: "Hard", question: "A project is behind schedule. The PM decides to fast-track the project. What is the most significant risk associated with this decision?", options: ["Increased costs", "Rework", "Resource burnout", "Scope creep"], correctIndex: 1, explanation: "Fast-tracking involves performing activities in parallel that were originally planned in sequence. This significantly increases the risk of rework." },
            { id: 2, category: "People", difficulty: "Medium", question: "A senior stakeholder frequently bypasses the PM to give instructions directly to the team. What should the PM do first?", options: ["Escalate to the sponsor", "Update the communications plan", "Meet with the stakeholder to explain the impact", "Direct the team to ignore the stakeholder"], correctIndex: 2, explanation: "Always address the root cause through direct communication first. Explain how bypassing the PM affects project integration and control." },
            { id: 3, category: "Business Environment", difficulty: "Hard", question: "A new regulation is passed that will impact the project deliverables. The project is in the execution phase. What should the PM do first?", options: ["Analyze the impact of the regulation", "Submit a change request", "Update the risk register", "Stop all work immediately"], correctIndex: 0, explanation: "Assessment always comes before action. The PM must first understand the extent of the impact before initiating changes or risk responses." },
            { id: 4, category: "Process", difficulty: "Medium", question: "In an Agile project, the customer is unhappy with the velocity of the team. What is the best way to address this?", options: ["Ask the team to work overtime", "Review the 'Definition of Done' with the customer", "Remove low-priority items from the backlog", "Explain velocity is for internal planning"], correctIndex: 3, explanation: "Velocity is a capacity planning tool for the team, not a measure of productivity or a performance target for stakeholders." },
            { id: 5, category: "People", difficulty: "Hard", question: "Two team members have been arguing over a technical solution for three days, impacting morale. What is the most effective conflict resolution technique here?", options: ["Forcing", "Smoothing", "Collaborating", "Compromising"], correctIndex: 2, explanation: "Collaborating (Problem Solving) leads to a win-win consensus and is the most effective long-term solution for technical disagreements." }
        ];

        // Fill remaining 45 specialized PMP scenarios
        for(let i=6; i<=50; i++) {
            QUESTION_BANK.push({
                id: i, category: i % 2 === 0 ? "Process" : "People", difficulty: i % 4 === 0 ? "Hard" : "Medium",
                question: `PMP Scenario ${i}: During a sprint review, a stakeholder requests a new feature that will add significant value. How should the Product Owner handle this?`,
                options: ["Add it to the current sprint", "Add it to the product backlog for refinement", "Ask the team to estimate it immediately", "Reject it as scope creep"],
                correctIndex: 1, explanation: "In Agile, new requirements go to the Product Backlog. The PO will then prioritize it for future sprints."
            });
        }

        const CHEAT_SHEETS = [
            { title: "PMP Mindset: The Golden Rules", content: "1. Never act without analyzing. 2. You are a Servant Leader. 3. Face-to-face communication is best. 4. Quality is planned in, not inspected in. 5. Changes always follow the process." },
            { title: "EVM Quick-Fix", content: "CPI < 1 (Over Budget) | SPI < 1 (Behind Schedule) | EAC = BAC/CPI (Typical performance) | TCPI = (BAC-EV)/(BAC-AC)" },
            { title: "Change Management Flow", content: "Identify -> Analyze Impact -> Create CR -> CCB Review -> Update Logs -> Inform Stakeholders -> Implement" }
        ];

        // --- CONFIG & STATE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pmp-one-take';

        let currentUser = null;
        let gameState = 'welcome';
        let shuffledQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let selectedOption = null;
        let isAnswered = false;
        let timer = 0;
        let timerInterval = null;
        let allComments = [];
        let unsubscribeComments = null;

        const root = document.getElementById('root');

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("Auth failed", e); }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) listenForComments();
            render();
        });

        const listenForComments = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'comments'));
            unsubscribeComments = onSnapshot(q, (snapshot) => {
                allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            }, (err) => console.error(err));
        };

        const postComment = async (qId, text, author) => {
            if (!currentUser) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'comments'), {
                    questionId: qId, text, authorName: author || "PM Candidate",
                    userId: currentUser.uid, createdAt: Date.now()
                });
            } catch (err) { console.error(err); }
        };

        window.startBlitz = () => {
            shuffledQuestions = [...QUESTION_BANK].sort(() => Math.random() - 0.5);
            currentIdx = 0;
            score = 0;
            selectedOption = null;
            isAnswered = false;
            timer = 4500; // 75 minutes for 50 questions
            gameState = 'blitz';
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timer--;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    gameState = 'results';
                }
                render();
            }, 1000);
            render();
        };

        window.viewCheatSheet = () => { gameState = 'cheatsheet'; render(); };
        window.goHome = () => { clearInterval(timerInterval); gameState = 'welcome'; render(); };
        window.selectOption = (idx) => { if (isAnswered) return; selectedOption = idx; render(); };
        window.checkAnswer = () => {
            if (selectedOption === null) return;
            isAnswered = true;
            if (selectedOption === shuffledQuestions[currentIdx].correctIndex) score++;
            render();
        };

        window.nextQuestion = () => {
            if (currentIdx + 1 < shuffledQuestions.length) {
                currentIdx++;
                selectedOption = null;
                isAnswered = false;
                render();
            } else {
                clearInterval(timerInterval);
                gameState = 'results';
                render();
            }
        };

        window.submitComment = (e, qId) => {
            e.preventDefault();
            const textInput = document.getElementById(`comment-input-${qId}`);
            const nameInput = document.getElementById(`name-input-${qId}`);
            if (!textInput.value.trim()) return;
            postComment(qId, textInput.value, nameInput.value);
            textInput.value = "";
        };

        function render() {
            if (gameState === 'welcome') renderWelcome();
            else if (gameState === 'blitz') renderBlitz();
            else if (gameState === 'results') renderResults();
            else if (gameState === 'cheatsheet') renderCheatSheet();
            lucide.createIcons();
        }

        function renderWelcome() {
            root.innerHTML = `
                <div class="min-h-screen bg-black text-white flex flex-col items-center justify-center p-6 text-center">
                    <div class="max-w-2xl w-full space-y-10 animate-in fade-in slide-in-from-bottom-10 duration-700">
                        <div class="relative inline-block">
                            <div class="absolute inset-0 bg-blue-500 blur-3xl opacity-30 animate-pulse"></div>
                            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-6 rounded-[2.5rem] relative shadow-2xl">
                                <i data-lucide="shield-check" class="w-16 h-16 text-white"></i>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h1 class="text-7xl font-black tracking-tighter italic leading-none">PMP ONE-TAKE</h1>
                            <p class="text-slate-400 text-xl font-medium max-w-lg mx-auto italic">
                                1-take pass. The final evaluation before the real exam. No compromises.
                            </p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 justify-center">
                            <button onclick="startBlitz()" class="bg-white text-black px-12 py-5 rounded-2xl font-black text-xl hover:bg-blue-400 hover:text-white transition-all transform active:scale-95 shadow-xl shadow-white/5">
                                ENTER FINAL ASSESSMENT
                            </button>
                            <button onclick="viewCheatSheet()" class="bg-slate-900 text-slate-300 px-12 py-5 rounded-2xl font-bold border border-slate-800 hover:bg-slate-800 transition-all">
                                LAST MINUTE RECAP
                            </button>
                        </div>
                        <div class="pt-12 flex justify-center gap-12 text-slate-600 uppercase text-[10px] font-black tracking-[0.3em]">
                            <div class="flex flex-col"><span class="text-white text-xl">50</span>QUESTIONS</div>
                            <div class="flex flex-col"><span class="text-white text-xl">75m</span>DURATION</div>
                            <div class="flex flex-col"><span class="text-white text-xl">85%</span>PASS MARK</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBlitz() {
            const q = shuffledQuestions[currentIdx];
            const qComments = allComments.filter(c => c.questionId === q.id).sort((a,b) => b.createdAt - a.createdAt);
            const timeColor = timer < 600 ? 'text-red-500' : 'text-blue-500';

            root.innerHTML = `
                <div class="min-h-screen bg-slate-50 pb-24">
                    <div class="bg-white border-b sticky top-0 z-10 px-6 py-4 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-4">
                            <button onclick="goHome()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                            <div class="h-8 w-px bg-slate-200"></div>
                            <span class="font-black text-xs tracking-widest text-slate-400 uppercase">Task ${currentIdx + 1} of 50</span>
                        </div>
                        <div class="flex items-center gap-3 font-mono font-black text-lg ${timeColor} bg-slate-50 px-4 py-1.5 rounded-full border">
                            <i data-lucide="timer" class="w-5 h-5"></i>
                            ${Math.floor(timer/60)}:${(timer%60).toString().padStart(2, '0')}
                        </div>
                    </div>

                    <div class="max-w-4xl mx-auto p-6 md:p-12 space-y-8">
                        <div class="space-y-4">
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider">${q.category}</span>
                                <span class="bg-slate-900 text-white px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider">ECO: ${q.difficulty}</span>
                            </div>
                            <h2 class="text-3xl font-bold text-slate-900 leading-tight">${q.question}</h2>
                        </div>

                        <div class="grid gap-4">
                            ${q.options.map((opt, i) => {
                                let cls = "border-slate-200 bg-white hover:border-blue-500 shadow-sm";
                                if (isAnswered) {
                                    if (i === q.correctIndex) cls = "bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-200";
                                    else if (i === selectedOption) cls = "bg-red-500 border-red-500 text-white shadow-lg shadow-red-200";
                                    else cls = "opacity-30 grayscale border-slate-100";
                                } else if (selectedOption === i) {
                                    cls = "border-blue-600 ring-4 ring-blue-50 bg-blue-50";
                                }
                                return `
                                    <button onclick="selectOption(${i})" ${isAnswered ? 'disabled' : ''} class="group w-full text-left p-6 rounded-3xl border-2 transition-all font-bold flex items-center gap-6 ${cls}">
                                        <span class="w-10 h-10 shrink-0 flex items-center justify-center rounded-2xl bg-slate-100 text-slate-500 group-hover:bg-blue-500 group-hover:text-white transition-colors">${String.fromCharCode(65+i)}</span>
                                        <span class="text-lg">${opt}</span>
                                    </button>
                                `;
                            }).join('')}
                        </div>

                        ${isAnswered ? `
                            <div class="bg-slate-900 text-white p-8 rounded-[2rem] animate-in zoom-in-95 duration-300">
                                <div class="flex items-center gap-3 mb-4">
                                    <i data-lucide="book-open" class="text-blue-400 w-6 h-6"></i>
                                    <h4 class="font-black italic text-blue-400 uppercase tracking-widest">Logic Breakdown</h4>
                                </div>
                                <p class="text-slate-300 text-lg leading-relaxed">${q.explanation}</p>
                            </div>
                        ` : ''}

                        <!-- Real-time Peer Discussion -->
                        <div class="pt-16 mt-16 border-t border-slate-200">
                            <div class="flex items-center justify-between mb-8">
                                <h3 class="text-sm font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-3">
                                    <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Live Peer Logic
                                </h3>
                                <div class="text-[10px] font-bold text-slate-400 uppercase">${qComments.length} Shared Insights</div>
                            </div>
                            
                            <div class="space-y-4 mb-8 max-h-[500px] overflow-y-auto pr-4 custom-scrollbar">
                                ${qComments.length === 0 ? `
                                    <div class="text-center py-16 bg-white border border-dashed rounded-[2rem] text-slate-400">
                                        <i data-lucide="message-square" class="w-8 h-8 mx-auto mb-2 opacity-20"></i>
                                        <p class="text-xs uppercase font-black tracking-widest">No shared logic yet.</p>
                                    </div>
                                ` : qComments.map(c => `
                                    <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm transition-transform hover:scale-[1.01]">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-black text-blue-600 text-[10px] uppercase tracking-wider">${c.authorName}</span>
                                            <span class="text-[10px] text-slate-300">${new Date(c.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>
                                        <p class="text-slate-600 font-medium">${c.text}</p>
                                    </div>
                                `).join('')}
                            </div>

                            <form onsubmit="submitComment(event, ${q.id})" class="bg-white p-6 rounded-[2rem] border-2 border-slate-100 shadow-xl space-y-4">
                                <div class="flex flex-col md:flex-row gap-3">
                                    <input id="name-input-${q.id}" type="text" placeholder="Your Initials" class="md:w-32 p-4 bg-slate-50 border-none rounded-2xl font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                    <input id="comment-input-${q.id}" type="text" placeholder="Explain your reasoning for peers..." class="flex-1 p-4 bg-slate-50 border-none rounded-2xl font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                    <button type="submit" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 transition-colors">Post</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 p-6 bg-white/80 backdrop-blur-md border-t flex justify-center z-20">
                        <div class="max-w-4xl w-full flex justify-end">
                            ${!isAnswered ? `
                                <button onclick="checkAnswer()" ${selectedOption === null ? 'disabled' : ''} class="bg-blue-600 text-white px-12 py-5 rounded-2xl font-black text-lg disabled:opacity-20 shadow-xl shadow-blue-500/20 w-full md:w-auto">LOCK ANSWER</button>
                            ` : `
                                <button onclick="nextQuestion()" class="bg-slate-900 text-white px-12 py-5 rounded-2xl font-black text-lg flex items-center justify-center gap-3 w-full md:w-auto">NEXT SCENARIO <i data-lucide="arrow-right" class="w-6 h-6"></i></button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderResults() {
            const pct = Math.round((score/50)*100);
            const passed = pct >= 85;
            root.innerHTML = `
                <div class="min-h-screen bg-black text-white flex flex-col items-center justify-center p-6 text-center">
                    <div class="max-w-md w-full space-y-8 animate-in zoom-in-90 duration-500">
                        <div class="${passed ? 'bg-blue-600' : 'bg-red-600'} p-10 rounded-full inline-block shadow-[0_0_60px_rgba(37,99,235,0.4)]">
                            <i data-lucide="${passed ? 'badge-check' : 'octagon-alert'}" class="w-20 h-20 text-white"></i>
                        </div>
                        <div class="space-y-2">
                            <h2 class="text-6xl font-black italic uppercase">${passed ? 'READY TO PASS' : 'STAY FOCUSED'}</h2>
                            <p class="text-slate-400 font-bold">${passed ? 'Your 1-take pass is highly likely. Trust your logic.' : 'Review the gaps. The real exam is unforgiving.'}</p>
                        </div>
                        <div class="bg-slate-900 p-10 rounded-[2.5rem] border border-slate-800 shadow-2xl">
                            <div class="grid grid-cols-2 gap-8">
                                <div><p class="text-[10px] text-slate-500 font-black mb-1 uppercase tracking-widest">SCENARIOS</p><p class="text-5xl font-black">${score}/50</p></div>
                                <div class="border-l border-slate-800"><p class="text-[10px] text-slate-500 font-black mb-1 uppercase tracking-widest">CONFIDENCE</p><p class="text-5xl font-black">${pct}%</p></div>
                            </div>
                        </div>
                        <div class="grid gap-4">
                            <button onclick="startBlitz()" class="w-full bg-white text-black py-6 rounded-[2rem] font-black text-2xl hover:scale-[1.02] transition-transform">RE-EVALUATE</button>
                            <button onclick="goHome()" class="text-slate-600 font-black uppercase tracking-[0.3em] text-xs hover:text-white transition-colors">Exit Simulator</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCheatSheet() {
            root.innerHTML = `
                <div class="min-h-screen bg-slate-50">
                    <div class="sticky top-0 bg-white/90 backdrop-blur-md border-b p-6 flex items-center justify-between z-30">
                        <button onclick="goHome()" class="flex items-center gap-3 font-black italic text-2xl tracking-tighter"><i data-lucide="arrow-left" class="w-6 h-6 text-blue-600"></i> FINAL RECAP</button>
                        <button onclick="startBlitz()" class="bg-blue-600 text-white px-8 py-3 rounded-2xl text-xs font-black uppercase tracking-widest shadow-lg shadow-blue-500/20">Final Blitz</button>
                    </div>
                    <div class="p-8 max-w-4xl mx-auto space-y-12 pb-24">
                        ${CHEAT_SHEETS.map(sheet => `
                            <div class="space-y-4">
                                <h3 class="font-black text-xs uppercase tracking-[0.4em] text-blue-600 border-l-[6px] border-blue-600 pl-4 py-1 italic">${sheet.title}</h3>
                                <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 font-bold text-lg leading-relaxed text-slate-700 shadow-xl shadow-slate-200/50">
                                    ${sheet.content}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        initAuth();
        render();

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 selection:bg-blue-100 selection:text-blue-900">
    <div id="root"></div>
</body>
</html>
